---
title: "Lab 03 - Exploratory Data Analysis"
date: "January 22, 2025"
---

```{r setup, message=FALSE, echo=FALSE, warning=FALSE}
#install.packages(c("data.table","tidyverse",leaflet", "reticulate", "lubridate"))
library(data.table)
library(leaflet)
library(tidyverse)
library(lubridate)
library(reticulate) #if you want to use Python code chunks
```

# Learning Goals

- Read in and get familiar with the meteorology dataset  
- Step through the EDA "checklist" presented in the class slides
- Practice making exploratory graphs

# Lab Description

We will work with the meteorological data presented in lecture. Recall the dataset consists of weather station readings in the contiguous US. 

**The objective of the lab is to find the weather station with the highest elevation and look at patterns in the time series of its wind speed and temperature.**

# Steps

### 1. Read in the data

First download and then read in with `data.table` function `fread()`


```{r, echo=TRUE, message=FALSE}
download.file(
  "https://raw.githubusercontent.com/JSC370/JSC370-2025/main/data/met/met_all.gz",
  destfile = "met_all.gz",
  method   = "curl",
  timeout  = 60
  )

met <- data.table::fread("met_all.gz")
```

### 2. Check the dimensions, headers, footers. How many columns, rows are there?

- Note you may use R or Python

```{r}
# dimension 
cat("Dimension:", dim(met), "\n")

# row
cat("Row:", nrow(met), "\n")

# col
cat("Col:", ncol(met), "\n")

# headers
print(head(met))

# footers
print(tail(met))
```

The dimension the dataset is (2377343, 30) with 2377343 rows and 30 columns. Based on the headers and the footers, there can be more than one observation in the same place and in the same day.

### 3. Take a look at the variables in the dataset. What kind of variables are there?

```{r}
str(met)
```

There are three variables in the dataset, which are integer, numeric, and character.


### 4. Take a closer look at the key variables. 

- Are there missing data? If so, make sure they are coded correctly. 
- Are there any unusual values that look suspicious? Recall the temperature values in the lecture.


```{r}
# The dataset only contains "2019"
table(met$year) 

# The dataset contains day from 1 to 31
table(met$day)

# Hour starts from 0 to 23
table(met$hour)

summary(met$temp)
summary(met$elev)
summary(met$wind.sp)
```
 
The elevation variable is unusual with value of 9999. We can replace 9999 with NA to indicate missing value.


### 5. Check the data against an external data source and make adjustments.

- Check that the range of elevations make sense.
- Google or ChatGPT is your friend here.
- Fix any problems that arise in your checks.

```{r}
met$elev[met$elev == 9999] <- NA
summary(met$elev)
```

```{r}
table(met$temp == -40, useNA = "always")
sum(is.na(met$temp))
met <- met[temp > -40]
sum(is.na(met$temp))
```

```{r}
met <- met[temp > -2]
met2 <- met[order(temp)]
head(unique(met2[,.(lat, lon, elev, temp)]))
```

I replace the data point with elevation 9999 with NA.


### 6. Calculate summary statistics

Remember to keep the initial question in mind. We want to pick out the weather station with maximum elevation and examine its wind speed and temperature.

Some ideas: 
1. select the weather station with maximum elevation; 
2. look at the correlation between temperature and wind speed; and 
3. look at the correlation between temperature and wind speed with hour and day of the month.

```{r}
# 1. Weather station with maximum elevation
highest <- met[elev == max(met$elev, na.rm = TRUE)]
summary(highest[, .(elev, lat, lon, temp, wind.sp)])
```

```{r}
cor(highest$temp, highest$wind.sp, use="complete")
```

```{r}
plot(
  x = highest$temp, 
  y = highest$wind.sp, 
  pch=19, 
  cex=0.5, 
  main = "Temperature and Wind Speed", 
  xlab = "Temperature (deg C)", ylab = "Wind Speed (km/h)")
```


```{r}
cat("Temperature vs Day:", cor(highest$temp, highest$day, use="complete"), "\n")
cat("Temperature vs Hour:", cor(highest$temp, highest$hour, use="complete"), "\n")
cat("Wind Speed vs Day:", cor(highest$wind.sp, highest$day, use="complete"), "\n")
cat("Wind Speed vs Hour:", cor(highest$wind.sp, highest$hour, use="complete"), "\n")
```


### 7. At what elevation is the highest weather station?

```{r}
cat("The highest wheather station has an evalation of", unique(highest$elev))
```

- The highest wheather station has an evalation of 4113

### 8. Exploratory graphs: Distributions

We should look at the distributions of all of the key variables (elevation, temp, wind speed) to make sure there are no remaining issues with the data.

```{r }
# Distribution of elevation
par(mfrow = c(1, 2))
hist(met$elev)
boxplot(met$elev)

# Distribution of temperature
par(mfrow = c(1, 2))
hist(met$temp)
boxplot(met$temp)

# Distribution of wind speed
par(mfrow = c(1, 2))
hist(met$wind.sp)
boxplot(met$wind.sp)
```
- Wind speed and elevation both are right-skew and have so many outliers.

One thing we should consider for later analyses is to log transform wind speed and elevation as the are very skewed.

### 9. Exploratory graphs: Time Series

Look at the time series of temperature and wind speed at this location. For this we will need to create a date-time variable for the x-axis.

```{r}
met$date <- with(met, ymd_h(paste(year, month, day, hour, spe="")))
summary(met$date)
```

```{r}
met <- met[order(date)]
```

```{r}
plot(met$date, met$temp, type="l")
```

With the date-time variable we can plot the time series of temperature and wind speed. Summarize any trends that you see in these time series plots.

- I think the trend is pretty much uniform with temperature range from 0 to 40.

### 10. Exploratory graphs: Map

Where is the weather station with highest elevation located? (i.e. make a map!)

```{r}
leaflet(highest) %>%
    addProviderTiles('OpenStreetMap') %>%
    addCircles(lat=~lat, lng=~lon, opacity=1, fillOpacity=1, radius=100)
```